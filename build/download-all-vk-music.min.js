var auth,config,console,database,download,fs,http,open,progress,prompt,random,request,taglib,tmp,url,_download,_downloadAudio;config={audioFolder:__dirname+"/audio/",vk:{appId:4509610,permissions:"audio,offline",version:5.24}},tmp={},random=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},http=require("http"),fs=require("fs"),url=require("url"),open=require("open"),auth=function(a){return tmp.userId&&tmp.token?void 0:(open("https://oauth.vk.com/authorize?client_id="+config.vk.appId+"&scope="+config.vk.permissions+"&display=page&v="+config.vk.version+"&response_type=token&redirect_uri=http://127.0.0.1:8080/?do=getTokenHtml"),http.createServer(function(b,c){var d;switch(d=url.parse(b.url,!0).query,d["do"]){case"getToken":return tmp.userId=d.userId,tmp.token=d.token,console.log("Auth completed successfully."),a(),c.end();case"getTokenHtml":return fs.readFile(__dirname+"/token.html",function(a,b){return a&&console.error(a),c.writeHead(200,{"Content-Type":"text/html"}),c.write(b),c.end()})}}).listen(8080))},request=require("request"),taglib=require("taglib"),database={update:function(a){var b,c;return b=tmp.userId,c=tmp.token,b&&c?(console.log("Download song's list from VK..."),request("https://api.vk.com/method/audio.get?owner_id="+b+"&access_token="+c+"&v="+config.vk.version,function(b,c,d){var e,f,g,h,i;if(b||200!==c.statusCode)return console.error(b);for(f=JSON.parse(d),tmp.audio=[],i=f.response.items,g=0,h=i.length;h>g;g++)e=i[g],tmp.audio.push({id:e.id,artist:e.artist.replace(/—/,"-"),title:e.title.replace(/—/,"-"),isCached:!1});return console.log("Song's list downloaded successfully."),database.renameDuplicates(),database.cache.get(function(b){return database.cache.write(b),a()})})):(console.error("Sync failed because auth is not loaded now.\nTrying to restart sync..."),setTimeout(function(){return database.update()},1e3))},cache:{_get:function(a,b,c,d){var e,f,g,h,i,j,k;return e=b[a],k=e.substr(0,e.length-4).split(" — "),f=k[0],j=k[1],h=config.audioFolder+e,i=taglib.tagSync(h),g={artist:f,title:j},g.id=i.comment?i.comment.replace(/\n\n.*/,"").replace(/VK id: ([0-9]+)/,"$1"):"",c.push(g),c.length===b.length?d(c):database.cache._get(++a,b,c,d)},get:function(a){var b,c,d;b=fs.readdirSync(config.audioFolder);for(c in b)d=b[c],"data.json"===d&&b.splice(c,1);return 0!==b.length?database.cache._get(0,b,[],a):a([])},write:function(a){var b,c,d,e,f,g,h;if(0!==a.length){for(h=tmp.audio,d=0,f=h.length;f>d;d++)for(b=h[d],e=0,g=a.length;g>e;e++)c=a[e],b.artist!==c.artist||b.title!==b.title||b.id!=c.id||(console.log("“"+b.artist+" — "+b.title+"” is cached."),b.isCached=!0);return console.log("Wrote cached audio to database.")}return console.log("There's no cached audio.")}},renameDuplicates:function(){var a,b,c,d,e,f,g;for(c=/\s\[([0-9]+)\]$/,f=tmp.audio,g=[],d=0,e=f.length;e>d;d++)a=f[d],g.push(function(){var d,e,f,g;for(f=tmp.audio,g=[],d=0,e=f.length;e>d;d++)b=f[d],""+a.artist+" — "+a.title==""+b.artist+" — "+b.title&&a.id!==b.id&&(b.title.match(c)?b.title=b.title.replace(c,function(a,b){var c;return c=parseInt(b),c++," ["+c+"]"}):b.title+=" [1]");return g}());return g}},progress=require("request-progress"),_download=function(a,b,c,d,e){var f;return console.clear(),f=config.audioFolder+b+".mp3",d[0]++,d[1]+=2,progress(request(a,function(){return{throttle:100}})).on("progress",function(a){var c,e,f,g,h,i,j,k;for(process.stdout.cursorTo(0,0),g="",c=process.stdout.columns,h=c-3,e=(h*(a.percent/100)).toFixed(),g+="[",i=1;e>=1?e>=i:i>=e;e>=1?i++:i--)g+="=";for(g+=">",j=1,k=h-e;k>=1?k>=j:j>=k;k>=1?j++:j--)g+=" ";return g+="]",process.stdout.write(g),process.stdout.cursorTo(0,1),f=""+(a.received/1024e3).toFixed(2)+" mb / "+(a.total/1024e3).toFixed(2)+" mb\n"+a.percent+"%\n"+d[0]+" of "+d[1]+"\n"+b,process.stdout.write(f)}).on("error",function(a){return console.error(a)}).pipe(fs.createWriteStream(f)).on("error",function(a){return console.error(a)}).on("close",function(){var a;return console.clear(),a=taglib.tagSync(f),a.comment="VK id: "+c+"\n\n",a.saveSync(),console.log(""+b+" saved successful."),e()})},download=function(a,b,c,d){var e,f;return f=tmp.userId,e=tmp.token,f&&e?request("https://api.vk.com/method/audio.getById?audios="+f+"_"+a+"&access_token="+e+"&v="+config.vk.version,function(e,f,g){var h,i;return e||200!==f.statusCode?console.error(e):(i=JSON.parse(g),h=i.response[0],_download(h.url,b,a,c,d))}):(console.error("Download song failed because auth is not loaded now.\nTrying to restart download..."),setTimeout(function(){return download(a,d)},1e3))},console=require("better-console"),prompt=require("prompt"),prompt.colors=!1,prompt.message=prompt.delimiter="",prompt.start(),prompt.get({name:"folder",description:"Enter audio folder (with /):"},function(a,b){return a?console.error(a):(config.audioFolder=b.folder,fs.existsSync(config.audioFolder)||(fs.mkdir(config.audioFolder,function(a){return console.error(a)}),console.log(config.audioFolder+" created.")),auth(function(){return database.update(function(){return _downloadAudio(0)})}))}),_downloadAudio=function(a){return tmp.audio[a].isCached===!0?(console.log("“"+tmp.audio[a].artist+" — "+tmp.audio[a].title+"” is cached."),a++,_downloadAudio(a)):download(tmp.audio[a].id,tmp.audio[a].artist.replace(/—/,"-")+" — "+tmp.audio[a].title.replace(/—/,"-"),[a,tmp.audio.length],function(){return a!==tmp.audio.length-1?(a++,_downloadAudio(a)):console.log("All songs downloaded.")})};