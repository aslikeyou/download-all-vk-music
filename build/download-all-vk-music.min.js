var auth,config,console,database,download,fs,http,mm,open,progress,prompt,random,request,tmp,url,_download,_downloadAudio;config={audioFolder:__dirname+"/audio/",vk:{appId:4509610,permissions:"audio,offline",version:5.24}},tmp={},random=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},http=require("http"),fs=require("fs"),url=require("url"),open=require("open"),auth=function(a){return tmp.userId&&tmp.token?void 0:(open("https://oauth.vk.com/authorize?client_id="+config.vk.appId+"&scope="+config.vk.permissions+"&display=page&v="+config.vk.version+"&response_type=token&redirect_uri=http://127.0.0.1:8080/?do=getTokenHtml"),http.createServer(function(b,c){var d;switch(d=url.parse(b.url,!0).query,d["do"]){case"getToken":return tmp.userId=d.userId,tmp.token=d.token,console.log("Auth completed successfully."),a(),c.end();case"getTokenHtml":return fs.readFile(__dirname+"/token.html",function(a,b){return a&&console.error(a),c.writeHead(200,{"Content-Type":"text/html"}),c.write(b),c.end()})}}).listen(8080))},request=require("request"),mm=require("musicmetadata"),database={update:function(a){var b,c;return b=tmp.userId,c=tmp.token,b&&c?request("https://api.vk.com/method/audio.get?owner_id="+b+"&access_token="+c+"&v="+config.vk.version,function(b,c,d){var e,f,g,h,i;if(b||200!==c.statusCode)return console.error(b);for(f=JSON.parse(d),tmp.audio=[],i=f.response.items,g=0,h=i.length;h>g;g++)e=i[g],tmp.audio.push({id:e.id,artist:e.artist.replace(/—/,"-"),title:e.title.replace(/—/,"-"),duration:e.duration,isCached:!1});return console.log("Id's sync completed successfully."),database.cache.get(function(b){return database.cache.write(b),a()})}):(console.error("Sync failed because auth is not loaded now.\nTrying to restart sync..."),setTimeout(function(){return database.update()},1e3))},cache:{_get:function(a,b,c,d){var e,f,g,h,i;return e=b[a],i=e.substr(0,e.length-4).split(" — "),f=i[0],h=i[1],g=fs.createReadStream(config.audioFolder+e),mm(g,{duration:!0}).on("metadata",function(e){return c.push({artist:f,title:h,duration:e.duration}),c.length===b.length?d(c):database.cache._get(++a,b,c,d)}).on("done",function(a){return a&&console.error(a+("\nError with "+f+" — "+h+".mp3\nTry to delete it and restart.")),g.destroy()})},get:function(a){var b,c,d;b=fs.readdirSync(config.audioFolder);for(c in b)d=b[c],"data.json"===d&&b.splice(c,1);return 0!==b.length?database.cache._get(0,b,[],a):a([])},write:function(a){var b,c,d,e,f,g,h;if(0!==a.length){for(h=tmp.audio,d=0,f=h.length;f>d;d++)for(b=h[d],e=0,g=a.length;g>e;e++)c=a[e],b.artist===c.artist&&b.title===c.title&&(b.duration===c.duration||b.duration+1===c.duration||b.duration-1===c.duration||0===c.duration)&&(console.log("“"+b.artist+" — "+b.title+"” is cached."),b.isCached=!0);return console.log("Wrote cached audio to database.")}return console.log("There's no cached audio.")}}},progress=require("request-progress"),_download=function(a,b,c,d){return console.clear(),c[0]++,c[1]++,progress(request(a,function(){return{throttle:100}})).on("progress",function(a){var d,e,f,g,h,i,j,k;for(process.stdout.cursorTo(0,0),g="",d=process.stdout.columns,h=d-3,e=(h*(a.percent/100)).toFixed(),g+="[",i=1;e>=1?e>=i:i>=e;e>=1?i++:i--)g+="=";for(g+=">",j=1,k=h-e;k>=1?k>=j:j>=k;k>=1?j++:j--)g+=" ";return g+="]",process.stdout.write(g),process.stdout.cursorTo(0,1),f=""+(a.received/1024e3).toFixed(2)+" mb / "+(a.total/1024e3).toFixed(2)+" mb\n"+a.percent+"%\n"+c[0]+" of "+c[1]+"\n"+b,process.stdout.write(f)}).on("error",function(a){return console.error(a)}).pipe(fs.createWriteStream(config.audioFolder+(""+b+".mp3"))).on("error",function(a){return console.error(a)}).on("close",function(){return console.clear(),console.log(""+b+" saved successful."),d()})},download=function(a,b,c){var d,e;return e=tmp.userId,d=tmp.token,e&&d?request("https://api.vk.com/method/audio.getById?audios="+e+"_"+a+"&access_token="+d+"&v="+config.vk.version,function(a,d,e){var f,g;return a||200!==d.statusCode?console.error(a):(g=JSON.parse(e),f=g.response[0],_download(f.url,f.artist.replace(/—/,"-")+" — "+f.title.replace(/—/,"-"),b,c))}):(console.error("Download song failed because auth is not loaded now.\nTrying to restart download..."),setTimeout(function(){return download(a,c)},1e3))},console=require("better-console"),prompt=require("prompt"),prompt.colors=!1,prompt.message=prompt.delimiter="",prompt.start(),prompt.get({name:"folder",description:"Enter audio folder (with /):"},function(a,b){return a?console.error(a):(config.audioFolder=b.folder,fs.existsSync(config.audioFolder)||(fs.mkdir(config.audioFolder,function(a){return console.error(a)}),console.log(config.audioFolder+" created.")),auth(function(){return database.update(function(){return _downloadAudio(0)})}))}),_downloadAudio=function(a){return tmp.audio[a].isCached===!0?(a++,_downloadAudio(a)):download(tmp.audio[a].id,[a,tmp.audio.length],function(){return a!==tmp.audio.length-1?(a++,_downloadAudio(a)):console.log("All songs downloaded.")})};